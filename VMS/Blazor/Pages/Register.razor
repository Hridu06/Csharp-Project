@page "/register"
@inject NavigationManager Nav
@inject AuthService AuthService
@inject IJSRuntime JS

@using VisitorManagementSystem.Application.DTOs
@using VisitorManagementSystem.Blazor.Models
@using VisitorManagementSystem.Blazor.Services

<h3>Register</h3>

<div class="form-group mb-2">
    <label>Full Name</label>
    <input @bind="RegisterModel.FullName" class="form-control" />
</div>
<div class="form-group mb-2">
    <label>Email</label>
    <input @bind="RegisterModel.Email" type="email" class="form-control" />
</div>
<div class="form-group mb-2">
    <label>Password</label>
    <input @bind="RegisterModel.Password" type="password" class="form-control" />
</div>
<div class="form-group mb-2">
    <label>Role</label>
    <select @bind="RegisterModel.Role" class="form-control">
        <option value="User">Visitor</option>
        <option value="Employee">Employee</option>
        <option value="Admin">Admin</option>
    </select>
</div>

<button class="btn btn-primary" @onclick="RegisterUser">Register</button>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="text-danger mt-2">@ErrorMessage</div>
}

@code {
    private VisitorManagementSystem.Blazor.Models.RegisterModel RegisterModel = new();
    private string ErrorMessage = "";

    private async Task RegisterUser()
    {
        ErrorMessage = "";

        if (string.IsNullOrEmpty(RegisterModel.FullName) ||
            string.IsNullOrEmpty(RegisterModel.Email) ||
            string.IsNullOrEmpty(RegisterModel.Password))
        {
            ErrorMessage = "Please fill all fields.";
            return;
        }

        try
        {
            bool success = await AuthService.RegisterAsync(new RegisterDTO
            {
                FullName = RegisterModel.FullName,
                Email = RegisterModel.Email,
                Password = RegisterModel.Password,
                Role = RegisterModel.Role
            });

            if (!success)
            {
                ErrorMessage = "Registration failed. Please try again.";
                return;
            }

            // On successful registration, navigate to login
            Nav.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Registration failed: {ex.Message}";
        }
    }
}
